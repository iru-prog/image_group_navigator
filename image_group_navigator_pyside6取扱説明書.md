# Image Group Navigator — 取扱説明書

## 概要

**Image Group Navigator** は、大量の画像ファイルを効率的にグループ化して閲覧するためのGUIツールです。

ファイル名のパターン（プレフィックス、中間番号）に基づいて3階層のグループ構造を自動生成し、階層的なナビゲーションとプレビュー表示を実現します。

---

## 主な特徴

- ✅ **3階層グループ化**：ファイル名から自動的にグループ構造を生成
- ✅ **高速プレビュー**：画像キャッシュと先読み機能で快適な閲覧
- ✅ **アニメーション対応**：GIF、APNGの自動再生
- ✅ **フルスクリーン表示**：ダブルクリックで全画面表示
- ✅ **柔軟なソート**：ファイル名順・作成日順を選択可能
- ✅ **先読み設定**：前後の画像を事前読み込み（0〜10枚）
- ✅ **ドラッグ&ドロップ対応**：フォルダを簡単に指定
- ✅ **Finder連携**：選択中のファイルを即座にFinderで表示
- ✅ **キーボードナビゲーション**：矢印キーやスペースキーで移動
- ✅ **設定の自動保存**：iCloud Drive経由で同期

---

## 動作環境

- **OS**: macOS専用（一部機能はmacOS依存）
- **Python**: Python 3.7以上
- **必要なライブラリ**:
  - PySide6（Qt for Python）
  - Pillow（PIL）（APNG対応）

---

## インストール方法

### 1. Pythonのインストール

Python 3.7以上がインストールされていることを確認します。

```bash
python3 --version
```

### 2. 依存ライブラリのインストール

```bash
pip install PySide6 Pillow
```

または、requirements.txtを使用する場合：

```bash
# requirements.txt の内容:
# PySide6
# Pillow

pip install -r requirements.txt
```

### 3. スクリプトの保存

提供されたPythonスクリプトを任意の場所に保存します（例：`image_group_navigator_pyside6.py`）。

### 4. 実行権限の付与（macOS）

```bash
chmod +x image_group_navigator_pyside6.py
```

---

## 使い方

### 起動方法

```bash
python3 image_group_navigator_pyside6.py
```

または、実行権限を付与済みの場合：

```bash
./image_group_navigator_pyside6.py
```

### ファイル名の命名規則

このツールは、以下の命名規則でファイル名をグループ化します：

**形式**: `プレフィックス_中間番号_ファイル名.拡張子`

**例**:
```
project_01_sketch.png
project_01_draft.png
project_02_final.png
project_02_export.png
photo_001_raw.jpg
photo_001_edited.jpg
photo_002_raw.jpg
```

### 基本的なワークフロー

#### ステップ1：フォルダを指定

以下のいずれかの方法でフォルダを指定します：

**方法A：ドラッグ&ドロップ**
- 画像フォルダをフォルダ入力欄にドラッグ&ドロップ
- 自動的にスキャンが開始されます

**方法B：参照ボタン**
- 「参照...」ボタンをクリックしてフォルダ選択ダイアログを開く

**方法C：手動入力**
- フォルダパスを直接入力し、Enterキーを押す

#### ステップ2：グループを選択

- **左リスト（グループ先頭）**: ファイル名の最初の部分（プレフィックス）でグループ化
- **中リスト（グループ中間）**: 中間番号でさらに細分化
- **右リスト（ファイル名）**: 個別のファイル名

#### ステップ3：画像を閲覧

- 右リストでファイルを選択するとプレビューが表示されます
- **ダブルクリック**または**Enterキー**でフルスクリーン表示
- **矢印キー（↑↓）**でグループ間移動
- **矢印キー（←→）**でファイル間移動（フルスクリーン時）

---

## UIの説明

### メイン画面

```
┌─────────────────────────────────────────────────────────┐
│ 画像フォルダ: [/path/to/folder] [参照...] [スキャン]    │
│ ソート順: ○ファイル名順 ○作成日順  先読み（前:3 次:7）  │
├─────────────────────────────────────────────────────────┤
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌───────────┐              │
│ │グループ│ │グループ│ │ファイル│ │プレビュー │              │
│ │先頭  │ │中間  │ │名   │ │           │              │
│ │     │ │     │ │     │ │ [画像]    │              │
│ │project│ │01   │ │sketch│ │           │              │
│ │photo │ │02   │ │draft │ │           │              │
│ │     │ │     │ │     │ │           │              │
│ │↑  ↓│ │↑  ↓│ │↑  ↓│ │           │              │
│ └─────┘ └─────┘ └─────┘ └───────────┘              │
└─────────────────────────────────────────────────────────┘
```

### コントロール

| 項目 | 説明 |
|------|------|
| **フォルダ入力欄** | ドロップまたは手動入力でフォルダパスを指定 |
| **参照ボタン** | フォルダ選択ダイアログを開く |
| **スキャンボタン** | フォルダを再スキャン |
| **ソート順ラジオボタン** | ファイル名順または作成日順を選択 |
| **先読み設定（前/次）** | プレビュー時の先読み枚数（0〜10枚） |
| **グループ先頭リスト** | プレフィックスでグループ化 |
| **グループ中間リスト** | 中間番号でサブグループ化 |
| **ファイル名リスト** | 個別のファイル名 |
| **プレビューエリア** | 選択中の画像を表示 |
| **↑↓ボタン** | リスト選択を上下に移動 |

### キーボードショートカット

#### メインウィンドウ

| キー | 動作 |
|------|------|
| **Enter** | 選択中のファイルを外部アプリで開く |
| **↑/↓** | リスト選択を移動（フォーカス中のリスト） |

#### フルスクリーン表示

| キー | 動作 |
|------|------|
| **F** | フルスクリーン解除 |
| **C** | Finderでファイルを表示 |
| **Esc** | フルスクリーン解除 |
| **←/→** | 前/次の画像に移動 |
| **↑/↓** | 前/次の左グループに移動 |
| **Space** | 前の中間グループに移動 |
| **Shift+Space** | 次の中間グループに移動 |
| **右クリック** | フルスクリーン解除 |

---

## 実際の使用例

### 例1：イラスト制作の工程管理

**ファイル構成:**
```
artwork_01_sketch.png
artwork_01_lineart.png
artwork_01_color.png
artwork_02_sketch.png
artwork_02_lineart.png
artwork_02_color.png
```

**使い方:**
1. フォルダをドロップしてスキャン
2. 左リスト：「artwork」が表示される
3. 中リスト：「01」「02」が表示される
4. 右リスト：各工程のファイルが表示される
5. 矢印キーで工程を比較

### 例2：写真のRAW→編集ワークフロー

**ファイル構成:**
```
photo_2025_raw.jpg
photo_2025_edited.jpg
photo_2025_final.jpg
photo_2026_raw.jpg
photo_2026_edited.jpg
```

**使い方:**
1. 「作成日順（新しい順）」を選択
2. 最新の写真から順番に表示される
3. 中間グループで各写真のバージョンを確認
4. フルスクリーンで詳細を確認

### 例3：ゲーム開発のスプライトシート管理

**ファイル構成:**
```
character_idle_001.png
character_idle_002.png
character_walk_001.png
character_walk_002.png
character_jump_001.png
```

**使い方:**
1. 左リスト：「character」
2. 中リスト：「idle」「walk」「jump」
3. 右リスト：各フレーム
4. APNGの場合は自動再生される

### 例4：建築プロジェクトの図面管理

**ファイル構成:**
```
building_1F_plan.png
building_1F_section.png
building_2F_plan.png
building_2F_section.png
```

**使い方:**
1. フロアごとに中間グループ化
2. 平面図と断面図を素早く切り替え
3. Finderで図面を開いて印刷

### 例5：大量の連番画像の整理

**ファイル構成:**
```
scan_001_page1.jpg
scan_001_page2.jpg
...
scan_100_page1.jpg
scan_100_page2.jpg
```

**使い方:**
1. 先読み設定を「前:0 次:10」に変更
2. 次のページをスムーズに閲覧
3. フルスクリーンで連続表示

---

## 先読み機能

### 先読み設定

- **前方先読み**：現在の画像より前の画像を何枚先読みするか（0〜10枚）
- **次方先読み**：現在の画像より後の画像を何枚先読みするか（0〜10枚）

### 推奨設定

| 用途 | 前方 | 次方 | 理由 |
|------|------|------|------|
| **通常閲覧** | 3 | 7 | バランスが良い |
| **前方向メイン** | 7 | 3 | 前の画像を頻繁に確認 |
| **次方向メイン** | 0 | 10 | 連続で次に進む |
| **ランダム閲覧** | 5 | 5 | 均等に先読み |
| **低メモリ環境** | 0 | 0 | メモリ使用を最小化 |

### 仕組み

1. 画像を選択すると、前後の指定枚数がバックグラウンドで読み込まれる
2. キャッシュに保存され、次回の表示が高速化
3. キャッシュサイズを超えると古い画像から削除（LRU方式）
4. フルスクリーン表示でもリアルタイムでキャッシュ状況を表示

**フルスクリーン時の表示例:**
```
3 / 15  -  artwork_01_color.png
キャッシュ: 前3/3 次7/7
```

---

## グループ化のルール

### ファイル名の解析

ファイル名は`_`（アンダースコア）で分割され、以下のように解釈されます：

```
[プレフィックス]_[中間番号]_[ファイル名].[拡張子]
```

**例:**
```
project_01_sketch.png
└─┬─┘ └┬┘ └──┬──┘
  │    │     └─ 右リスト: sketch
  │    └─────── 中リスト: 01
  └──────────── 左リスト: project
```

### 自然順ソート

数字を含むファイル名は自然順にソートされます：

```
正しい順序:
file_1.png
file_2.png
file_10.png
file_20.png

（数値順でないソート結果:）
file_1.png
file_10.png  ← 10が2より前
file_2.png
file_20.png
```

---

## トラブルシューティング

### ❌ 「画像ファイルが見つかりませんでした」

**原因**: フォルダ内に対応形式の画像がありません。

**対応形式**:
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)
- BMP (.bmp)
- WebP (.webp)

**解決方法**:
1. フォルダパスが正しいか確認
2. 画像ファイルが上記の形式か確認
3. ファイルが隠しファイルになっていないか確認

### ❌ グループ化がうまくいかない

**原因**: ファイル名が命名規則に従っていません。

**解決方法**:
- ファイル名に`_`（アンダースコア）を含める
- 形式：`プレフィックス_中間番号_ファイル名.拡張子`

**例（悪い例）:**
```
project-01-sketch.png  ← ハイフンはNG
project01sketch.png    ← アンダースコアなし
```

**例（良い例）:**
```
project_01_sketch.png
project_01_draft.png
```

### ❌ 画像が表示されない

**原因**: ファイルが破損しているか、形式がサポートされていません。

**解決方法**:
1. ファイルを別のアプリで開いて確認
2. 対応形式に変換（PNGやJPEGなど）
3. ファイルの読み取り権限を確認

### ❌ APNGが再生されない

**原因**: Pillowライブラリがインストールされていないか、古いバージョンです。

**解決方法**:
```bash
# Pillowを最新版にアップデート
pip install --upgrade Pillow
```

### ❌ メモリ使用量が多い

**原因**: 先読み数とキャッシュサイズが大きすぎます。

**解決方法**:
1. 先読み数を減らす（例：前0 次0）
2. 高解像度の画像を縮小
3. 不要なアプリを終了

### ❌ Finderで表示できない

**原因**: macOS以外のOSで実行しているか、AppleScriptが動作しません。

**解決方法**:
- この機能はmacOS専用です
- ターミナルから以下を試してください：
  ```bash
  osascript -e 'tell application "Finder" to activate'
  ```

### ❌ フルスクリーンで画像が切り替わらない

**原因**: キャッシュに画像が読み込まれていない可能性があります。

**解決方法**:
1. 数秒待って再度試す
2. 先読み数を増やす
3. メインウィンドウで画像を手動で選択してキャッシュを確認

### ❌ 設定が保存されない

**原因**: iCloud Driveのパスに書き込み権限がないか、iCloud Driveが無効です。

**解決方法**:
1. iCloud Driveが有効か確認（システム設定 → Apple ID → iCloud）
2. フォルダの書き込み権限を確認：
   ```bash
   ls -ld "/Users/iru/Library/Mobile Documents/com~apple~CloudDocs/設定用ファイル"
   ```

---

## よくある質問（FAQ）

### Q1. 3つに分割されない場合は？

A. ファイル名に`_`が1つしかない場合は、以下のように扱われます：
- `prefix_filename.png` → 左リスト：`prefix`、中リスト：（空）、右リスト：`filename`

### Q2. 動画ファイルは表示できますか？

A. 現在のバージョンでは動画ファイル（MP4、MOVなど）には対応していません。GIFとAPNGのアニメーション画像のみ対応しています。

### Q3. 複数のフォルダを同時に開けますか？

A. 現在のバージョンでは1フォルダのみです。複数フォルダの画像を扱う場合は、シンボリックリンクで1つのフォルダにまとめるか、フォルダを統合してください。

### Q4. フルスクリーン時にズームできますか？

A. 現在のバージョンではズーム機能はありません。画像は画面サイズに合わせて自動的にフィットします。

### Q5. ファイル名をまとめて変更できますか？

A. このツールには一括リネーム機能はありません。macOSの「Automator」や`rename`コマンドを使用してください。

### Q6. Windows/Linuxでも動作しますか？

A. PySide6はクロスプラットフォーム対応ですが、以下の機能はmacOS専用です：
- Finderでファイルを表示
- AppleScriptによる操作

基本的なプレビュー機能は他のOSでも動作する可能性があります。

### Q7. ショートカットキーをカスタマイズできますか？

A. 現在のバージョンではショートカットキーはハードコードされています。将来のバージョンでカスタマイズ機能が追加予定です。

### Q8. iCloud Drive以外に設定を保存できますか？

A. コードを編集すれば可能です：
```python
# 変更前
config_dir = Path(
    "/Users/iru/Library/Mobile Documents/com~apple~CloudDocs/設定用ファイル"
)

# 変更後（例：ホームディレクトリ）
config_dir = Path.home() / ".config" / "image_group_navigator"
```

---

## 技術情報

### キャッシュ方式

- **LRU（Least Recently Used）方式**: 最近使用されていない画像から削除
- **OrderedDict**を使用して順序を管理
- キャッシュサイズはデフォルト5枚（プレビュー用）、10枚（フルスクリーン用）

### 画像読み込み

1. **メインスレッド**: UI操作
2. **ワーカースレッド（ImagePreloader）**: バックグラウンドで画像を読み込み
3. **シグナル/スロット**: スレッド間通信

### APNG対応

PillowライブラリでAPNGを解析：

1. `Image.open()`でPNGファイルを開く
2. `is_animated`属性でAPNG判定
3. 各フレームを順番に読み込み
4. `duration`情報でタイマーを設定

### 設定ファイル

**保存先**: `~/Library/Mobile Documents/com~apple~CloudDocs/設定用ファイル/image_group_navigator_config.json`

**内容**:
```json
{
  "folder": "/path/to/images",
  "sort_order": "name",
  "preload_backward": 3,
  "preload_forward": 7,
  "cache_size": 5
}
```

---

## カスタマイズ方法

### 1. 対応する画像形式の追加

```python
# scan_folder メソッド内
valid_exts = (".jpg", ".jpeg", ".png", ".gif", ".bmp", ".webp", ".tiff")  # ← .tiff を追加
```

### 2. デフォルト先読み数の変更

```python
# __init__ メソッド内
self.preload_backward = 3  # ← 好きな数値に変更
self.preload_forward = 7   # ← 好きな数値に変更
```

### 3. キャッシュサイズの変更

```python
# ImageCache クラス
def __init__(self, max_size=10):  # ← 10を好きな数値に変更
```

### 4. ウィンドウサイズの変更

```python
# __init__ メソッド内
self.resize(1200, 700)  # ← 幅1200、高さ700を変更
```

### 5. ショートカットキーの変更

```python
# ShortcutManager クラス
DEFAULT_SHORTCUTS = {
    "fullscreen_exit": "F",  # ← 好きなキーに変更
    "reveal_in_finder": "C",
    # ...
}
```

### 6. グループ化ロジックの変更

ファイル名の分割方法を変更する場合：

```python
def extract_middle_number(name):
    """ファイル名から中間番号を抽出"""
    parts = name.split("_")  # ← 区切り文字を変更（例: "-" や "."）
    if len(parts) >= 3:
        return parts[1]
    return ""
```

---

## 応用例

### 1. タイムラプス写真の管理

連番ファイルを時系列で管理：

```bash
# ファイル名例
timelapse_0001_frame.jpg
timelapse_0002_frame.jpg
...
timelapse_9999_frame.jpg
```

### 2. 3DCGレンダリングの工程管理

レンダリングパスごとに管理：

```bash
scene01_diffuse_001.png
scene01_specular_001.png
scene01_ambient_001.png
scene01_final_001.png
```

### 3. ドキュメントスキャンの整理

複数ページの書類を管理：

```bash
contract_page01_scan.jpg
contract_page02_scan.jpg
invoice_page01_scan.jpg
invoice_page02_scan.jpg
```

### 4. Webデザインのバリエーション管理

デザインパターンを管理：

```bash
website_header_v1.png
website_header_v2.png
website_footer_v1.png
website_footer_v2.png
```

---

## 関連ツール

Image Group Navigatorと組み合わせて使うと便利なツール：

### ファイル名一括変更

- **Renamer**: GUI一括リネームツール
  ```bash
  brew install --cask renamer
  ```

- **rename（Perl）**: コマンドライン一括リネーム
  ```bash
  brew install rename
  rename 's/old/new/' *.jpg
  ```

### 画像変換

- **ImageMagick**: 画像形式変換・リサイズ
  ```bash
  brew install imagemagick
  convert input.jpg -resize 50% output.jpg
  ```

- **sips（macOS標準）**: 画像変換
  ```bash
  sips -s format png input.jpg --out output.png
  ```

### ファイル管理

- **Finder Tags**: macOSのタグ機能で分類
- **Path Finder**: 高機能なファイルマネージャー

---

## 注意事項

- ⚠️ **大量の画像は時間がかかる**: 数千枚の画像があると初回スキャンに時間がかかります
- ⚠️ **メモリ使用量**: 高解像度画像の先読みはメモリを消費します
- ⚠️ **ファイル名規則**: `_`区切りの命名規則に従う必要があります
- ⚠️ **macOS専用機能**: Finder連携やAppleScriptはmacOS専用です
- ⚠️ **iCloud Drive**: 設定保存にiCloud Driveを使用（変更可能）
- ⚠️ **APNG対応**: Pillowライブラリが必要です

---

## ライセンス・免責事項

このツールは教育・個人利用目的で提供されています。使用は自己責任で行ってください。

---

## サポート

問題が発生した場合は、以下を確認してください：

1. PySide6とPillowが正しくインストールされているか
   ```bash
   pip show PySide6 Pillow
   ```

2. Python 3.7以上が使用されているか
   ```bash
   python3 --version
   ```

3. フォルダが存在し、読み取り権限があるか
   ```bash
   ls -ld /path/to/folder
   ```

4. 画像ファイルが対応形式か
   ```bash
   ls /path/to/folder/*.{jpg,png,gif}
   ```

5. ターミナルから実行してエラーメッセージを確認
   ```bash
   python3 image_group_navigator_pyside6.py
   ```

それでも解決しない場合は、エラーメッセージを確認してください。

---

**バージョン**: 1.0
**最終更新**: 2025年
**対応OS**: macOS（一部機能はクロスプラットフォーム）
**対応形式**: JPEG, PNG, GIF, BMP, WebP, APNG
